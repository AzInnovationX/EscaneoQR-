<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escaneo QR y de Barras - Escáner Profesional</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #10b981;
            --dark-color: #1e293b;
            --light-bg: #f8fafc;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-color);
        }
        
        .scanner-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .scanner-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .scanner-header h1 {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .scanner-header p {
            color: #64748b;
            font-size: 1.1rem;
        }
        
        #video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            background-color: #000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        #canvas {
            display: none;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 10%; }
            100% { top: 90%; }
        }
        
        .scan-corners {
            position: absolute;
            top: 20%;
            left: 10%;
            width: 80%;
            height: 60%;
            border: 2px solid #10b981;
            border-radius: 8px;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }
        
        .scan-corners::before,
        .scan-corners::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #10b981;
        }
        
        .scan-corners::before {
            top: -10px;
            left: -10px;
            border-right: none;
            border-bottom: none;
        }
        
        .scan-corners::after {
            bottom: -10px;
            right: -10px;
            border-left: none;
            border-top: none;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .btn-scan {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }
        
        .btn-scan:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(37, 99, 235, 0.4);
        }
        
        .btn-scan:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-container {
            background-color: #f1f5f9;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border-left: 4px solid var(--success-color);
            display: none;
        }
        
        .result-container h3 {
            color: var(--success-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .result-content {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            border: 1px solid #e2e8f0;
        }
        
        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-copy {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-copy:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-new {
            background-color: #64748b;
            color: white;
        }
        
        .btn-new:hover {
            background-color: #475569;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background-color: var(--success-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .error-message {
            background-color: #fee;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
            border-left: 4px solid #ef4444;
        }
        
        .device-info {
            text-align: center;
            margin-bottom: 1rem;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .debug-info {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: #0c4a6e;
            display: none;
        }
        
        @media (max-width: 768px) {
            .scanner-container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-scan {
                width: 100%;
                max-width: 300px;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scanner-container">
            <div class="scanner-header">
                <h1><i class="fas fa-qrcode"></i> Escaneo QR y de Barras</h1>
                <p>Escáner profesional de códigos QR y de barras</p>
            </div>
            
            <div class="device-info">
                <i class="fas fa-mobile-alt"></i> <span id="device-info">Detectando dispositivo...</span>
            </div>
            
            <div id="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                    <div class="scan-corners"></div>
                </div>
            </div>
            
            <div class="controls">
                <button id="start-btn" class="btn btn-scan">
                    <i class="fas fa-play"></i> Iniciar Escaneo
                </button>
                <button id="stop-btn" class="btn btn-scan" disabled>
                    <i class="fas fa-stop"></i> Detener Escaneo
                </button>
            </div>
            
            <div id="result-container" class="result-container">
                <h3><i class="fas fa-check-circle"></i> Código Detectado</h3>
                <div id="result-content" class="result-content"></div>
                <div class="actions">
                    <button id="copy-btn" class="btn btn-action btn-copy">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                    <button id="new-scan-btn" class="btn btn-action btn-new">
                        <i class="fas fa-redo"></i> Nuevo Escaneo
                    </button>
                </div>
            </div>
            
            <div id="error-message" class="error-message"></div>
            
            <div id="debug-info" class="debug-info">
                <strong>Información de depuración:</strong>
                <div id="debug-content"></div>
            </div>
            
            <div class="footer">
                <p>Escaneo QR y de Barras &copy; 2023 - Tecnología de escaneo avanzada</p>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i> ¡Texto copiado al portapapeles!
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jsQR Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const resultContainer = document.getElementById('result-container');
            const resultContent = document.getElementById('result-content');
            const copyBtn = document.getElementById('copy-btn');
            const newScanBtn = document.getElementById('new-scan-btn');
            const notification = document.getElementById('notification');
            const errorMessage = document.getElementById('error-message');
            const deviceInfo = document.getElementById('device-info');
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            
            // Variables de estado
            let scanning = false;
            let stream = null;
            let animationFrameId = null;
            let qrLibraryLoaded = false;
            
            // Verificar si la librería jsQR está cargada
            function checkQRLibrary() {
                if (typeof jsQR === 'undefined') {
                    showError('La librería jsQR no se pudo cargar. Por favor, verifica tu conexión a internet.');
                    return false;
                }
                qrLibraryLoaded = true;
                return true;
            }
            
            // Detectar tipo de dispositivo
            function detectDevice() {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                
                if (/android/i.test(userAgent)) {
                    deviceInfo.innerHTML = '<i class="fas fa-mobile-alt"></i> Dispositivo Android detectado';
                } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    deviceInfo.innerHTML = '<i class="fas fa-mobile-alt"></i> Dispositivo iOS detectado';
                } else {
                    deviceInfo.innerHTML = '<i class="fas fa-desktop"></i> Computadora de escritorio detectada';
                }
            }
            
            // Iniciar escaneo
            async function startScanning() {
                // Verificar que la librería jsQR esté cargada
                if (!checkQRLibrary()) {
                    return;
                }
                
                try {
                    // Solicitar permisos de cámara
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    video.srcObject = stream;
                    
                    // Esperar a que el video esté listo
                    video.onloadedmetadata = () => {
                        // Configurar canvas con las dimensiones del video
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        // Iniciar bucle de escaneo
                        scanning = true;
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        resultContainer.style.display = 'none';
                        errorMessage.style.display = 'none';
                        
                        debugContent.innerHTML = `Canvas configurado: ${canvas.width}x${canvas.height}<br>Video listo: ${video.videoWidth}x${video.videoHeight}`;
                        debugInfo.style.display = 'block';
                        
                        scanFrame();
                    };
                    
                } catch (err) {
                    console.error('Error al acceder a la cámara:', err);
                    showError('No se pudo acceder a la cámara. Asegúrate de haber concedido los permisos necesarios.');
                }
            }
            
            // Detener escaneo
            function stopScanning() {
                scanning = false;
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
            
            // Escanear frame
            function scanFrame() {
                if (!scanning) return;
                
                const context = canvas.getContext('2d');
                
                // Dibujar el frame actual del video en el canvas
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Obtener los datos de la imagen
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Intentar decodificar el código QR
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        console.log("Código QR detectado:", code.data);
                        handleScanResult(code.data);
                    } else {
                        // Continuar escaneando
                        animationFrameId = requestAnimationFrame(scanFrame);
                    }
                } else {
                    // Si el video no está listo, esperar un poco más
                    animationFrameId = requestAnimationFrame(scanFrame);
                }
            }
            
            // Manejar resultado del escaneo
            function handleScanResult(data) {
                stopScanning();
                resultContent.textContent = data;
                resultContainer.style.display = 'block';
                
                // Vibración en dispositivos móviles
                if ('vibrate' in navigator) {
                    navigator.vibrate(200);
                }
            }
            
            // Copiar al portapapeles
            async function copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(resultContent.textContent);
                    showNotification();
                } catch (err) {
                    console.error('Error al copiar:', err);
                    showError('No se pudo copiar el texto al portapapeles.');
                }
            }
            
            // Mostrar notificación
            function showNotification() {
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
            
            // Mostrar error
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            // Event Listeners
            startBtn.addEventListener('click', startScanning);
            stopBtn.addEventListener('click', stopScanning);
            copyBtn.addEventListener('click', copyToClipboard);
            newScanBtn.addEventListener('click', () => {
                resultContainer.style.display = 'none';
                startScanning();
            });
            
            // Inicializar
            detectDevice();
            
            // Verificar si el navegador soporta la API necesaria
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Tu navegador no soporta el acceso a la cámara. Por favor, usa un navegador moderno como Chrome, Firefox o Edge.');
                startBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
